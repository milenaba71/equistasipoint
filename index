<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema muscoloscheletrico - Viewer 3D</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#111b27;
      --txt:#e7eef8;
      --muted:#a8b3c3;
      --accent:#4da3ff;
      --border:rgba(255,255,255,.08);
      --btn:rgba(255,255,255,.06);
      --btnH:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--txt);overflow:hidden}
    .app{display:grid;grid-template-columns:360px 1fr;height:100vh}
    .left{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-right:1px solid var(--border);
      padding:18px 16px;
      overflow:auto;
    }
    h1{font-size:20px;margin:0 0 10px}
    p{color:var(--muted);line-height:1.4;margin:0 0 14px}
    .card{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px;
      margin:12px 0;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--txt);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .btn:hover{background:var(--btnH)}
    .btn.primary{border-color:rgba(77,163,255,.35);background:rgba(77,163,255,.12)}
    .btn.primary:hover{background:rgba(77,163,255,.18)}
    .small{font-size:12px;color:var(--muted)}
    .list{
      margin-top:10px;
      max-height:45vh;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:14px;
    }
    .item{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    .item:last-child{border-bottom:none}
    .item:hover{background:rgba(255,255,255,.04)}
    .tag{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }
    .sel{outline:2px solid rgba(77,163,255,.5);background:rgba(77,163,255,.08)}
    .right{position:relative}
    canvas{display:block}
    /* toolbar verticale tipo screenshot */
    .toolbar{
      position:absolute;
      top:70px;
      left:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:10;
    }
    .toolbtn{
      width:44px;height:44px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .toolbtn:hover{background:rgba(255,255,255,.1)}
    .hud{
      position:absolute;
      right:16px;
      bottom:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:10;
    }
    .hud .toolbtn{width:46px;height:46px;border-radius:14px}
    .toast{
      position:absolute;
      left:18px;
      bottom:16px;
      padding:10px 12px;
      background:rgba(0,0,0,.45);
      border:1px solid var(--border);
      border-radius:14px;
      color:var(--muted);
      font-size:12px;
      z-index:10;
      max-width:520px;
    }
    input[type="text"]{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      outline:none;
    }
    input[type="text"]:focus{border-color:rgba(77,163,255,.4)}
  </style>
</head>
<body>
<div class="app">
  <aside class="left">
    <h1>Sistema muscoloscheletrico completo</h1>
    <p>
      Modello 3D con muscoli (e, se presenti nel GLB, tessuti connettivi e scheletro).
      Puoi ruotare, zoomare, selezionare e isolare strutture anatomiche.
    </p>

    <div class="card">
      <div class="row">
        <button class="btn primary" id="btnReset">Reset vista</button>
        <button class="btn" id="btnShowAll">Mostra tutto</button>
        <button class="btn" id="btnIsolate">Isola selezione</button>
        <button class="btn" id="btnXray">X-Ray</button>
      </div>
      <div style="height:10px"></div>
      <div class="small">Suggerimento: clicca un muscolo nel viewer o dalla lista qui sotto.</div>
    </div>

    <div class="card">
      <div class="small" style="margin-bottom:8px">Cerca struttura</div>
      <input id="search" type="text" placeholder="es. deltoid, biceps, rectus..." />
      <div class="list" id="muscleList"></div>
    </div>

    <div class="card">
      <div class="small">Selezione</div>
      <div id="selectionName" style="margin-top:6px;font-weight:600">—</div>
      <div id="selectionMeta" class="small" style="margin-top:6px">Clicca una struttura per vedere i dettagli.</div>
    </div>

    <div class="small" style="opacity:.9">
      Caricamento modello: <code>human_muscles.glb</code><br/>
      Se vuoi etichette “pulite”, rinomina le mesh nel GLB (es. <code>Deltoid_L</code>).
    </div>
  </aside>

  <main class="right" id="view">
    <div class="toolbar">
      <div class="toolbtn" id="toolOrbit" title="Orbit (rotazione)">
        <!-- icona -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M12 4a8 8 0 1 0 8 8" stroke="white" stroke-opacity=".9" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M20 12c0 4.4-3.6 8-8 8" stroke="white" stroke-opacity=".35" stroke-width="1.8" stroke-linecap="round"/>
          <circle cx="20" cy="12" r="2" fill="white" fill-opacity=".85"/>
        </svg>
      </div>
      <div class="toolbtn" id="toolSelect" title="Seleziona">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M5 4l7 16 2-7 7-2L5 4z" stroke="white" stroke-opacity=".9" stroke-width="1.8" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="toolbtn" id="toolMeasure" title="Misura (demo)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M4 17l16-10" stroke="white" stroke-opacity=".9" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M7 16l2 3M10 14l2 3M13 12l2 3M16 10l2 3" stroke="white" stroke-opacity=".55" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="toolbtn" id="toolInfo" title="Info">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="9" stroke="white" stroke-opacity=".9" stroke-width="1.8"/>
          <path d="M12 11v6" stroke="white" stroke-opacity=".9" stroke-width="1.8" stroke-linecap="round"/>
          <circle cx="12" cy="8" r="1.2" fill="white" fill-opacity=".9"/>
        </svg>
      </div>
    </div>

    <div class="hud">
      <div class="toolbtn" id="btnZoomIn" title="Zoom +">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 6v12M6 12h12" stroke="white" stroke-opacity=".9" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="toolbtn" id="btnZoomOut" title="Zoom -">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M6 12h12" stroke="white" stroke-opacity=".9" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="toolbtn" id="btnFullscreen" title="Fullscreen">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M8 4H4v4M16 4h4v4M8 20H4v-4M16 20h4v-4" stroke="white" stroke-opacity=".9" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <div class="toast" id="toast">
      Controlli: trascina per ruotare • rotella per zoom • clic per selezionare
    </div>
  </main>
</div>

<!-- Three.js via CDN -->
<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
  import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
  import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
  import { RGBELoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/RGBELoader.js';

  const container = document.getElementById('view');

  // Renderer
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  container.appendChild(renderer.domElement);

  // Scene + camera
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x070a0f);

  const camera = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.01, 1000);
  camera.position.set(0, 1.45, 3.5);

  // Controls
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.target.set(0, 1.25, 0);

  // Lights (pulito, tecnico)
  const key = new THREE.DirectionalLight(0xffffff, 1.15);
  key.position.set(2.5, 4, 2.5);
  scene.add(key);

  const fill = new THREE.DirectionalLight(0xffffff, 0.55);
  fill.position.set(-2.5, 2.5, -2);
  scene.add(fill);

  const amb = new THREE.AmbientLight(0xffffff, 0.25);
  scene.add(amb);

  // (Opzionale) ambiente HDR per materiale più “medicale”
  // Commenta se non vuoi dipendenze extra.
  new RGBELoader().load(
    'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/studio_small_09_1k.hdr',
    (tex) => {
      tex.mapping = THREE.EquirectangularReflectionMapping;
      scene.environment = tex;
    }
  );

  // State
  let root = null;
  const meshes = [];
  const originalVisibility = new Map();
  const originalMaterials = new Map();

  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();
  let selected = null;

  // UI refs
  const listEl = document.getElementById('muscleList');
  const searchEl = document.getElementById('search');
  const selNameEl = document.getElementById('selectionName');
  const selMetaEl = document.getElementById('selectionMeta');
  const toastEl = document.getElementById('toast');

  // Helpers: highlight
  const highlightMaterial = new THREE.MeshStandardMaterial({
    color: 0x4da3ff,
    roughness: 0.35,
    metalness: 0.0,
    emissive: 0x143a66,
    emissiveIntensity: 0.65
  });

  function setToast(msg){
    toastEl.textContent = msg;
  }

  function prettifyName(n){
    // esempi: Deltoid_L -> Deltoid (L)
    return n
      .replace(/_/g,' ')
      .replace(/\bL\b|\bLeft\b/i,'(L)')
      .replace(/\bR\b|\bRight\b/i,'(R)')
      .trim();
  }

  function classifyByName(name){
    const n = name.toLowerCase();
    if (n.includes('bone') || n.includes('femur') || n.includes('tibia') || n.includes('humerus') || n.includes('skull')) return 'Scheletro';
    if (n.includes('tendon') || n.includes('fascia') || n.includes('aponeuros')) return 'Connettivo';
    return 'Muscolo';
  }

  function clearSelection(){
    if (!selected) return;
    // ripristina materiale
    const orig = originalMaterials.get(selected.uuid);
    if (orig) selected.material = orig;
    selected = null;
    selNameEl.textContent = '—';
    selMetaEl.textContent = 'Clicca una struttura per vedere i dettagli.';
    // UI list remove selection highlight
    [...listEl.querySelectorAll('.item')].forEach(i => i.classList.remove('sel'));
  }

  function selectMesh(m){
    if (!m) return;
    clearSelection();
    selected = m;

    // evidenzia
    if (!originalMaterials.has(m.uuid)) originalMaterials.set(m.uuid, m.material);
    m.material = highlightMaterial;

    // UI
    selNameEl.textContent = prettifyName(m.name || 'Struttura');
    selMetaEl.textContent = `Tipo: ${classifyByName(m.name || '')} • Mesh: ${m.type} • Triangoli: ~${m.geometry?.index ? Math.floor(m.geometry.index.count/3) : 'n/d'}`;

    // evidenzia in lista
    const row = listEl.querySelector(`[data-uuid="${m.uuid}"]`);
    if (row) row.classList.add('sel');

    setToast('Selezionato: ' + prettifyName(m.name || 'Struttura'));
  }

  function showAll(){
    meshes.forEach(m => m.visible = true);
    setToast('Mostra tutto');
  }

  function isolateSelected(){
    if (!selected) { setToast('Seleziona una struttura prima'); return; }
    meshes.forEach(m => m.visible = (m === selected));
    setToast('Isolata: ' + prettifyName(selected.name || 'Struttura'));
  }

  let xray = false;
  function toggleXray(){
    xray = !xray;
    meshes.forEach(m => {
      const mat = originalMaterials.get(m.uuid) || m.material;
      if (!originalMaterials.has(m.uuid)) originalMaterials.set(m.uuid, mat);

      const base = originalMaterials.get(m.uuid);
      // crea una copia per non distruggere l'originale
      const xr = base.clone();
      xr.transparent = xray;
      xr.opacity = xray ? 0.35 : 1.0;
      xr.depthWrite = !xray;
      xr.roughness = 0.35;
      xr.metalness = 0.0;

      // se selezionato, mantieni highlight
      if (selected && m.uuid === selected.uuid) return;
      m.material = xr;
    });
    setToast(xray ? 'X-Ray ON' : 'X-Ray OFF');
  }

  function resetView(){
    controls.target.set(0, 1.25, 0);
    camera.position.set(0, 1.45, 3.5);
    controls.update();
    setToast('Vista resettata');
  }

  function buildList(){
    listEl.innerHTML = '';
    const frag = document.createDocumentFragment();

    const sorted = [...meshes].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    sorted.forEach(m=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.uuid = m.uuid;
      div.innerHTML = `
        <div style="min-width:0">
          <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${prettifyName(m.name || 'Struttura')}</div>
          <div class="small" style="margin-top:2px">${m.name || ''}</div>
        </div>
        <span class="tag">${classifyByName(m.name || '')}</span>
      `;
      div.addEventListener('click', ()=>{
        focusOnMesh(m);
        selectMesh(m);
      });
      frag.appendChild(div);
    });
    listEl.appendChild(frag);
  }

  function filterList(){
    const q = (searchEl.value||'').trim().toLowerCase();
    [...listEl.children].forEach(row=>{
      const uuid = row.dataset.uuid;
      const m = meshes.find(x=>x.uuid===uuid);
      const name = (m?.name||'').toLowerCase();
      row.style.display = (!q || name.includes(q)) ? '' : 'none';
    });
  }

  function focusOnMesh(m){
    // centra camera sul bounding box della mesh
    const box = new THREE.Box3().setFromObject(m);
    const size = new THREE.Vector3();
    const center = new THREE.Vector3();
    box.getSize(size);
    box.getCenter(center);

    const maxDim = Math.max(size.x, size.y, size.z);
    const dist = maxDim * 2.2;

    controls.target.copy(center);
    const dir = new THREE.Vector3(0.25, 0.15, 1).normalize();
    camera.position.copy(center.clone().add(dir.multiplyScalar(dist)));
    controls.update();
  }

  // Load GLB
  const loader = new GLTFLoader();
  loader.load(
    './human_muscles.glb',
    (gltf)=>{
      root = gltf.scene;
      root.traverse((obj)=>{
        if (obj.isMesh){
          obj.castShadow = false;
          obj.receiveShadow = false;
          obj.frustumCulled = true;

          // materiale standard “tecnico” se il modello non lo ha
          if (!obj.material){
            obj.material = new THREE.MeshStandardMaterial({ color: 0xd55b5b, roughness: 0.45, metalness: 0.0 });
          } else {
            // uniforma un minimo per look “medicale”
            obj.material.roughness = obj.material.roughness ?? 0.4;
            obj.material.metalness = obj.material.metalness ?? 0.0;
          }

          meshes.push(obj);
          originalVisibility.set(obj.uuid, obj.visible);
          originalMaterials.set(obj.uuid, obj.material);
        }
      });

      // scala/posizione se necessario
      // root.scale.setScalar(1.0);

      scene.add(root);
      buildList();
      setToast('Modello caricato. Clicca una struttura.');

      // auto-fit iniziale
      const box = new THREE.Box3().setFromObject(root);
      const center = new THREE.Vector3();
      const size = new THREE.Vector3();
      box.getCenter(center);
      box.getSize(size);
      controls.target.copy(center);
      camera.position.set(center.x, center.y + size.y*0.15, center.z + Math.max(size.x,size.y,size.z)*1.6);
      controls.update();
    },
    (xhr)=>{
      if (xhr.total) {
        const p = Math.round((xhr.loaded/xhr.total)*100);
        setToast('Caricamento: ' + p + '%');
      }
    },
    (err)=>{
      console.error(err);
      setToast('Errore: non riesco a caricare human_muscles.glb (controlla percorso/nome).');
    }
  );

  // Click picking
  function onPointerDown(e){
    // evita click sul pannello
    const rect = renderer.domElement.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    const y = -(((e.clientY - rect.top) / rect.height) * 2 - 1);
    mouse.set(x,y);

    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(meshes, true);
    if (hits.length){
      const hit = hits[0].object;
      focusOnMesh(hit);
      selectMesh(hit);
    } else {
      clearSelection();
      setToast('Nessuna selezione');
    }
  }
  renderer.domElement.addEventListener('pointerdown', onPointerDown);

  // UI buttons
  document.getElementById('btnReset').addEventListener('click', resetView);
  document.getElementById('btnShowAll').addEventListener('click', ()=>{ showAll(); clearSelection(); });
  document.getElementById('btnIsolate').addEventListener('click', isolateSelected);
  document.getElementById('btnXray').addEventListener('click', toggleXray);
  searchEl.addEventListener('input', filterList);

  document.getElementById('btnZoomIn').addEventListener('click', ()=>{
    camera.position.lerp(controls.target.clone().add(camera.position.clone().sub(controls.target).multiplyScalar(0.85)), 1);
  });
  document.getElementById('btnZoomOut').addEventListener('click', ()=>{
    camera.position.lerp(controls.target.clone().add(camera.position.clone().sub(controls.target).multiplyScalar(1.15)), 1);
  });

  document.getElementById('btnFullscreen').addEventListener('click', async ()=>{
    if (!document.fullscreenElement) await container.requestFullscreen();
    else await document.exitFullscreen();
  });

  // toolbar “modalità” (demo: orbit/select)
  let mode = 'select';
  const toolSelect = document.getElementById('toolSelect');
  const toolOrbit = document.getElementById('toolOrbit');

  function setMode(m){
    mode = m;
    const isSelect = (mode === 'select');
    toolSelect.style.outline = isSelect ? '2px solid rgba(77,163,255,.5)' : 'none';
    toolOrbit.style.outline = !isSelect ? '2px solid rgba(77,163,255,.5)' : 'none';
    // Se orbit-only: disabilita picking
    renderer.domElement.style.cursor = isSelect ? 'crosshair' : 'grab';
    setToast(isSelect ? 'Modalità selezione' : 'Modalità orbit');
  }
  toolSelect.addEventListener('click', ()=>setMode('select'));
  toolOrbit.addEventListener('click', ()=>setMode('orbit'));

  renderer.domElement.addEventListener('pointerdown', (e)=>{
    if (mode !== 'select') return; // in orbit non seleziono
    onPointerDown(e);
  }, { passive:true });

  document.getElementById('toolMeasure').addEventListener('click', ()=>{
    setToast('Misura: demo (si può implementare con 2 click + distanza).');
  });
  document.getElementById('toolInfo').addEventListener('click', ()=>{
    setToast('Info: seleziona una struttura per dettagli.');
  });

  setMode('select');

  // Resize
  function onResize(){
    const w = container.clientWidth;
    const h = container.clientHeight;
    camera.aspect = w/h;
    camera.updateProjectionMatrix();
    renderer.setSize(w,h);
  }
  window.addEventListener('resize', onResize);

  // Render loop
  function animate(){
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();
</script>
</body>
</html>
